Tab Monitor Closer — расширение, которое автоматически закрывает «непрочитанные» вкладки и может сохранять ссылки закрытых вкладок в HTML-файл.

Описание
- Расширение отслеживает время открытия вкладки и поведение пользователя (прокрутка, клики). Если вкладка открыта дольше настроенного порога и не была просматриваема (без прокрутки/взаимодействия), расширение закрывает её автоматически.
- Закрытые вкладки добавляются в локальную историю и (опционально) в агрегированный HTML-лог, который можно сохранить в папку Downloads.

Установка (разработка)
1. Откройте chrome://extensions (или edge://extensions) и включите Developer mode.
2. Нажмите "Load unpacked" и выберите папку этого проекта.
3. После загрузки откройте Popup расширения для настройки.

Основные элементы UI (popup)
- Timeout (HH:MM): порог, после которого вкладка считается кандидатом на закрытие. Значение сохраняется в `chrome.storage.sync.thresholdHours` и `thresholdMinutes`.
- Save: сохранить порог.
- Run now: запустить немедленную проверку вкладок (сообщение `runCheckNow`).


Telegram
- Bot API Token, Chat ID: опционально, для отправки уведомлений через Telegram Bot API.

HTML Log (сохранение закрытых вкладок)
- Имя HTML файла (`logFileName`): пользователь может указать имя файла (по умолчанию `closed-tabs.html`). Это сохраняется в `chrome.storage.sync.logFileName`.
- Выбрать или создать файл: открывает поведение сохранения. При включённой опции "Save As каждый раз" будет интерактивный диалог Save As (saveAs:true). В противном случае выполняется автоматический экспорт (overwrite).
- Экспорт сейчас: немедленно сгенерировать агрегированный HTML-файл и сохранить/скачать его.
- Grant downloads permission: запрашивает разрешение `downloads` у браузера (нужно для сохранения HTML).
- Current saved file: показывает текущее сохранённое имя файла (после Save As это обновляется автоматически).

Опции управления экспортом
- Save As каждый раз (`chrome.storage.sync.logSaveAsEveryTime`): если включено, при экспорте будет показываться Save As диалог (интерактивное сохранение). Если выключено — файл скачивается автоматически и перезаписывает предыдущую версию (conflictAction: 'overwrite').
- Export on close (`chrome.storage.sync.logExportOnClose`): если включено (по умолчанию true), агрегированный HTML-файл будет автоматически перегенерирован и скачан (overwrite) при каждом закрытии вкладки, которая попала в историю закрытий. Если выключено — записи сохраняются локально (`htmlLogEntries`), но автоматические скачивания не выполняются (чтобы избежать частых загрузок).

История и восстановление вкладок
- Расширение хранит список закрытых вкладок в `chrome.storage.local.closedHistory`. Его можно просмотреть в popup.
- Для каждой записи есть кнопка Restore — она попытается восстановить вкладку (через chrome.sessions.restore или открыть URL).
- Undo: при автоматическом закрытии показывается системное уведомление с кнопкой Undo. Нажатие попытаться восстановит вкладку.

Ключи хранения (коротко)
- chrome.storage.sync:
  - thresholdHours, thresholdMinutes — порог закрытия.
  - notifyEmail — адрес для отправки писем.
  - tgToken, tgChatId — Telegram настройки.
  - logFileName — сохранённое имя HTML-файла.
  - logSaveAsEveryTime — boolean: использовать SaveAs (интерактивно) при экспорте.
  - logExportOnClose — boolean: выполнять автоматический экспорт при закрытии (по умолчанию true).
- chrome.storage.local:
  - openTimes — временные метки открытия вкладок (key: tabId).
  - closedHistory — массив последних закрытых вкладок (объекты {url,title,ts,restore}).
  - htmlLogEntries — агрегированные записи для HTML экспорта.
  - undoMap — карта для Undo уведомлений.
  - badgeCount — счётчик для бейджа.
  - gmailAccessToken, gmailAccessTokenExp — временное хранение токена Gmail OAuth (локально).

Сообщения между popup и background
- getClosedHistory — вернуть history + badgeCount
- runCheckNow — немедленная проверка
- resetBadge — сбросить бейдж
- clearHistory — очистить историю
- restoreClosed (index) — восстановить запись из истории
- gmail-connect / gmail-send — OAuth и отправка почты
- telegram-send — отправка telegram
- exportHtmlNow — сгенерировать и скачать агрегированный HTML (overwrite)
- saveAsLogFile (suggestedName) — сгенерировать HTML и показать Save As диалог (saveAs:true); сохраняет итоговое имя в `chrome.storage.sync.logFileName`

Поведение логирования и загрузок
- При каждом добавлении в `htmlLogEntries` (addToHistory) расширение по умолчанию вызывает `writeHtmlLog()` — он читает `htmlLogEntries` и создаёт агрегированный HTML, затем сохраняет/скачивает файл с conflictAction:'overwrite'. Это выполняется только если `logExportOnClose` включён.
- Если пользователь предпочитает Manual-only, он может выключить `Export on close` и вызывать экспорт вручную.

Отладка и проверка
- В popup есть кнопки Run now и Export now для ручного тестирования.
- Просмотрите консоль service worker (Extensions -> background service worker) для логов и ошибок.
- Для проблем с OAuth проверьте `OAUTH_WEB_CLIENT_ID` в `background.js`.

Безопасность и права
- Разрешения в `manifest.json` включают: tabs, storage, alarms, scripting, notifications, sessions, identity, downloads.
- `downloads` запрашивается динамически при необходимости, и может быть отозван пользователем через UI браузера.

Примечания по реализации
- Из-за ограничений расширений Chrome модификация произвольных файлов на диске без Save As невозможна; вместо этого агрегированный HTML скачивается в папку Downloads. Для прямой записи потребовалось бы нативное приложение (Native Messaging).
- Мы сохраняем агрегированный список в `chrome.storage.local.htmlLogEntries` и используем его для генерации единого файла при экспорте.

Если нужно
- Могу добавить отдельный экспортный файл или кнопку «Скачать HTML агрегат» с опцией фильтрации по дате.
- Могу перенести CSS в отдельный файл или улучшить локализацию UI.

---
Файл создан автоматически как руководство по настройке расширения и описанию его параметров.
