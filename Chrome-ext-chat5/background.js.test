async function getAuthTokenInteractive() {
  return new Promise((resolve, reject) => {
    chrome.identity.getAuthToken({ interactive: true }, (token) => {
      if (chrome.runtime.lastError || !token) {
        reject(chrome.runtime.lastError || new Error("No token"));
      } else resolve(token);
    });
  });
}

function clearTokens() {
  return new Promise((resolve) => {
    chrome.identity.clearAllCachedAuthTokens(() => resolve());
  });
}

function toBase64Url(str) {
  return btoa(unescape(encodeURIComponent(str)))
    .replace(/\+/g, "-").replace(/\//g, "_").replace(/=+$/, "");
}

async function sendGmail({ to, subject, body }) {
  const mime = [
    `To: ${to}`,
    `Subject: ${subject}`,
    "Content-Type: text/plain; charset=utf-8",
    "",
    body || ""
  ].join("\r\n");

  const raw = toBase64Url(mime);

  let token = await getAuthTokenInteractive();

  const doSend = async () => {
    const res = await fetch("https://gmail.googleapis.com/gmail/v1/users/me/messages/send", {
      method: "POST",
      headers: {
        "Authorization": `Bearer ${token}`,
        "Content-Type": "application/json"
      },
      body: JSON.stringify({ raw })
    });
    if (!res.ok) {
      const text = await res.text();
      throw new Error(`Gmail send failed: ${res.status} ${text}`);
    }
    return res.json();
  };

  try {
    return await doSend();
  } catch (e) {
    // ≈сли токен сломан > очистить и попробовать снова
    if (String(e).includes("401")) {
      await clearTokens();
      token = await getAuthTokenInteractive();
      return await doSend();
    }
    throw e;
  }
}

chrome.runtime.onMessage.addListener((msg, _sender, sendResponse) => {
  (async () => {
    try {
      if (msg?.type === "auth.signIn") {
        await getAuthTokenInteractive();
        sendResponse({ ok: true });
      } else if (msg?.type === "auth.signOut") {
        await clearTokens();
        sendResponse({ ok: true });
      } else if (msg?.type === "gmail.send") {
        const r = await sendGmail(msg.payload);
        sendResponse({ ok: true, data: r });
      }
    } catch (err) {
      console.error(err);
      sendResponse({ ok: false, error: String(err) });
    }
  })();
  return true; // async
});
